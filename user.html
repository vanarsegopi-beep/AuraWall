<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AuraWall Pro | Premium 4K</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg: #05070a; --accent: #00d2ff; --card: #11141b; --text: #ffffff; --gray: #8b949e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Splash Screen */
        #splash { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: 0.8s ease; }
        .splash-logo { font-family: 'Montserrat'; font-size: 2.5rem; font-weight: 800; color: #fff; }
        .splash-logo span { color: var(--accent); }

        /* Compact Header */
        header { 
            padding: 10px 18px; position: sticky; top: 0; background: rgba(5,7,10,0.9); 
            backdrop-filter: blur(20px); z-index: 100; border-bottom: 1px solid #1c2128;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-brand { font-family: 'Montserrat'; font-size: 1.2rem; font-weight: 800; color: #fff; text-decoration: none; }
        .header-brand span { color: var(--accent); }
        .h-btn { position: relative; font-size: 1.2rem; color: var(--gray); cursor: pointer; }
        .dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: #ff3b3b; border-radius: 50%; display: none; border: 2px solid var(--bg); }

        /* Categories */
        .tabs { display: flex; gap: 20px; padding: 15px; overflow-x: auto; scrollbar-width: none; }
        .tab { font-size: 0.8rem; font-weight: 600; color: var(--gray); white-space: nowrap; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); padding-bottom: 4px; }

        /* Main Grid */
        .container { padding: 5px 12px 160px 12px; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .card { aspect-ratio: 9/16; background: var(--card); border-radius: 15px; overflow: hidden; position: relative; animation: fadeInUp 0.5s ease forwards; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .stats { position: absolute; bottom: 0; width: 100%; padding: 8px; background: linear-gradient(transparent, rgba(0,0,0,0.8)); display: flex; justify-content: space-between; font-size: 0.65rem; color: #fff; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); width: 90%; background: rgba(17, 20, 27, 0.9); backdrop-filter: blur(20px); height: 62px; border-radius: 20px; display: flex; justify-content: space-around; align-items: center; z-index: 600; border: 1px solid #21262d; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-link { color: var(--gray); font-size: 1.3rem; transition: 0.2s; }
        .nav-link.active { color: var(--accent); transform: scale(1.1); }

        /* Ads Space */
        .ads-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #000; z-index: 500; display: flex; align-items: center; justify-content: center; border-top: 1px solid #1c2128; }

        /* Wallpaper Modal */
        #view-modal { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; flex-direction: column; }
        .m-header { padding: 25px; display: flex; justify-content: space-between; position: absolute; width: 100%; z-index: 10; }
        .m-img-box { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .m-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .m-footer { padding: 20px 20px 60px; display: flex; gap: 12px; position: absolute; bottom: 0; width: 100%; }
        .dl-button { flex: 1; height: 58px; background: var(--accent); color: #000; border: none; border-radius: 18px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; }
        .fav-button { width: 58px; height: 58px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 18px; color: #fff; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; }

        /* Notification Modal */
        #notif-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; padding: 40px 20px; flex-direction: column; }
        .notif-card { background: #11141b; border-radius: 15px; padding: 20px; border-left: 4px solid var(--accent); margin-bottom: 15px; animation: fadeInUp 0.3s ease; }
        .notif-close { align-self: flex-end; font-size: 1.5rem; color: #fff; margin-bottom: 20px; }

        /* Spinner */
        .spin { width: 22px; height: 22px; border: 3px solid rgba(0,0,0,0.1); border-top-color: #000; border-radius: 50%; animation: rot 0.8s linear infinite; display: none; }
        @keyframes rot { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash"><div class="splash-logo">AURA<span>WALL</span></div></div>

    <!-- Header -->
    <header>
        <i class="fa-solid fa-bars-staggered h-btn" onclick="toggleMenu()"></i>
        <a href="#" class="header-brand">AURA<span>WALL</span><span>PRO</span></a>
        <div class="h-btn" onclick="openNotif()">
            <i class="fa-solid fa-bell"></i>
            <div class="dot" id="notif-dot"></div>
        </div>
    </header>

    <!-- Search Section -->
    <div style="padding: 10px 15px;">
        <input type="text" id="search-box" style="width:100%; background:#161b22; border:1px solid #30363d; padding:12px 15px; border-radius:12px; color:#fff; outline:none;" placeholder="Find wallpapers..." oninput="handleSearch(this.value)">
    </div>

    <!-- Sorting Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="setSort('New', this)">New</div>
        <div class="tab" onclick="setSort('Famous', this)">Famous</div>
        <div class="tab" onclick="setSort('Old', this)">Old Version</div>
    </div>

    <!-- Main Grid -->
    <main class="container">
        <div class="grid" id="main-grid"></div>
    </main>

    <!-- Navigation -->
    <nav class="bottom-nav">
        <i class="fa-solid fa-house nav-link active" onclick="switchNav('home', this)"></i>
        <i class="fa-solid fa-heart nav-link" onclick="switchNav('fav', this)"></i>
        <i class="fa-solid fa-fire nav-link" onclick="switchNav('popular', this)"></i>
    </nav>

    <!-- Ad Placeholder (Adsterra code goes here) -->
    <div class="ads-container" id="ad-box">
        <span style="font-size: 9px; color: #333;">ADVERTISEMENT</span>
    </div>

    <!-- Full Image View -->
    <div id="view-modal">
        <div class="m-header">
            <i class="fa-solid fa-arrow-left" onclick="closeModal()" style="font-size: 1.5rem;"></i>
            <i class="fa-solid fa-share-nodes" onclick="shareWallpaper()"></i>
        </div>
        <div class="m-img-box"><img id="full-img" src="" crossOrigin="anonymous"></div>
        <div class="m-footer">
            <button class="fav-button" id="like-btn"><i class="fa-regular fa-heart"></i></button>
            <button class="dl-button" id="main-dl-btn">
                <div class="spin" id="dl-spin"></div>
                <span id="dl-txt">DOWNLOAD 4K</span>
            </button>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notif-modal">
        <i class="fa-solid fa-xmark notif-close" onclick="closeNotif()"></i>
        <h2 style="margin-bottom: 20px;">Updates & News</h2>
        <div id="notif-list">
            <!-- Notifications will load here -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBC0oDkZFlafDxt81OFThS9CU7yKIfsIMY",
            authDomain: "aurawallpapers-5bb5c.firebaseapp.com",
            databaseURL: "https://aurawallpapers-5bb5c-default-rtdb.firebaseio.com",
            projectId: "aurawallpapers-5bb5c",
            storageBucket: "aurawallpapers-5bb5c.firebasestorage.app",
            messagingSenderId: "333593104062",
            appId: "1:333593104062:web:3c3017c2b9e45cbf2518ef"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let allWallpapers = [], favs = JSON.parse(localStorage.getItem('aura_favs')) || [], currentWall = null, currentSort = 'New';

        // 1. Initial Data Load & Delete Fix
        window.onload = () => {
            db.ref('wallpapers').on('value', snap => {
                const data = snap.val();
                allWallpapers = data ? Object.keys(data).map(k => ({id:k, ...data[k]})) : [];
                checkNewUpload();
                applyFilterAndSort();
                setTimeout(() => { document.getElementById('splash').style.display = 'none'; }, 1500);
            });
            
            // Listen for Admin Messages
            db.ref('messages').on('value', snap => {
                const msg = snap.val();
                renderNotifs(msg);
            });
        };

        function renderGrid(data) {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = '';
            data.forEach(w => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openView(w);
                card.innerHTML = `<img src="${w.imageURL}" loading="lazy"><div class="stats"><span><i class="fa-solid fa-eye"></i> ${w.views || 0}</span><span><i class="fa-solid fa-heart"></i> ${w.likes || 0}</span></div>`;
                grid.appendChild(card);
            });
        }

        function setSort(type, el) {
            currentSort = type;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            applyFilterAndSort();
        }

        function applyFilterAndSort() {
            let res = [...allWallpapers];
            if(currentSort === 'New') res.reverse();
            else if(currentSort === 'Famous') res.sort((a,b) => (b.views||0) - (a.views||0));
            renderGrid(res);
        }

        // 2. DOWNLOAD FIX (Gallery Optimized)
        async function handleDownload() {
            const txt = document.getElementById('dl-txt'), spin = document.getElementById('dl-spin');
            txt.style.display = 'none'; spin.style.display = 'block';

            try {
                const response = await fetch(currentWall.imageURL);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `AuraWall_4K_${Date.now()}.jpg`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                window.open(currentWall.imageURL, '_blank');
                alert("Download issue? Please long press the image and select 'Save Image'");
            }

            txt.style.display = 'block'; spin.style.display = 'none';
        }

        // 3. Functional Notifications
        function checkNewUpload() {
            const lastId = localStorage.getItem('aura_last_id');
            if(allWallpapers.length > 0 && allWallpapers[allWallpapers.length-1].id !== lastId) {
                document.getElementById('notif-dot').style.display = 'block';
            }
        }

        function renderNotifs(msgData) {
            const list = document.getElementById('notif-list');
            list.innerHTML = '';
            if(!msgData) { list.innerHTML = '<p style="color:var(--gray)">No new updates yet.</p>'; return; }
            Object.keys(msgData).reverse().forEach(key => {
                const m = msgData[key];
                const card = document.createElement('div');
                card.className = 'notif-card';
                card.innerHTML = `<h4>${m.title || 'Notification'}</h4><p style="font-size:0.85rem; color:var(--gray); margin-top:5px;">${m.body || m.text}</p>`;
                list.appendChild(card);
            });
        }

        function openNotif() {
            document.getElementById('notif-modal').style.display = 'flex';
            document.getElementById('notif-dot').style.display = 'none';
            if(allWallpapers.length > 0) localStorage.setItem('aura_last_id', allWallpapers[allWallpapers.length-1].id);
        }

        // UI Interactions
        function openView(w) {
            currentWall = w;
            document.getElementById('full-img').src = w.imageURL;
            document.getElementById('view-modal').style.display = 'flex';
            db.ref('wallpapers/'+w.id+'/views').transaction(v => (v || 0) + 1);
            updateLikeButton();
            document.getElementById('main-dl-btn').onclick = handleDownload;
        }

        function updateLikeButton() {
            const isFav = favs.some(f => f.id === currentWall.id);
            const btn = document.getElementById('like-btn');
            btn.innerHTML = isFav ? '<i class="fa-solid fa-heart" style="color:#ff3b3b"></i>' : '<i class="fa-regular fa-heart"></i>';
            btn.onclick = () => {
                if(isFav) {
                    favs = favs.filter(f => f.id !== currentWall.id);
                    db.ref('wallpapers/'+currentWall.id+'/likes').transaction(v => (v || 0) - 1);
                } else {
                    favs.push(currentWall);
                    db.ref('wallpapers/'+currentWall.id+'/likes').transaction(v => (v || 0) + 1);
                }
                localStorage.setItem('aura_favs', JSON.stringify(favs));
                updateLikeButton();
            };
        }

        function handleSearch(v) { renderGrid(allWallpapers.filter(w => w.title?.toLowerCase().includes(v.toLowerCase()))); }
        function switchNav(t, e) {
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active')); e.classList.add('active');
            if(t === 'fav') renderGrid(favs); else if(t === 'popular') renderGrid([...allWallpapers].sort((a,b) => (b.views||0)-(a.views||0))); else applyFilterAndSort();
        }
        function closeModal() { document.getElementById('view-modal').style.display = 'none'; }
        function closeNotif() { document.getElementById('notif-modal').style.display = 'none'; }
        function shareWallpaper() { if(navigator.share) navigator.share({title:'AuraWall Pro', url:currentWall.imageURL}); }
        function toggleMenu() { alert("Use Home tab for wallpapers!"); }
    </script>
</body>
</html>